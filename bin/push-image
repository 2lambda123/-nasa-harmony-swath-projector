#!/bin/bash
# Pushes the docker image to an ECR repo. Requires AWS credentials to be set.

set -ex

image="sds/swot-reproject"
tag=${1:-latest}

region=${AWS_DEFAULT_REGION-"us-west-2"}

account=$(aws sts get-caller-identity --output text --query 'Account')

# Need to create a temporary file with the docker login command.
# Call dos2unix to ensure no issues on login.
temp_docker_login_file=$(mktemp tmp.docker.login.file.XXXXXXXXXXXXXXXXXXX)
aws ecr get-login --no-include-email --region ${region} > $temp_docker_login_file
chmod 755 $temp_docker_login_file
dos2unix $temp_docker_login_file
sh $temp_docker_login_file
rm $temp_docker_login_file

docker tag ${image}:${tag} ${account}.dkr.ecr.${region}.amazonaws.com/${image}:${tag}

# Create ECR repo if it doesn't exist
aws ecr describe-repositories --repository-names ${image} || aws ecr create-repository --repository-name ${image}

docker push ${account}.dkr.ecr.${region}.amazonaws.com/${image}:${tag}